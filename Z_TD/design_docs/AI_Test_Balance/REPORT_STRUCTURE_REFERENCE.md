# Balance Analysis Report Structure Reference

## Overview

This document provides a complete technical reference for the structure of balance analysis reports generated by Z-TD. Use this as a reference when working with report data programmatically or when extending the report system.

---

## Complete Report Schema

### Root Level Fields

```typescript
interface GameLogEntry {
  // Session metadata
  timestamp: string;              // ISO 8601 format: "2025-10-15T15:45:30.000Z"
  sessionId: string;              // Unique session identifier
  isAIRun: boolean;               // true = AI player, false = manual play
  duration: number;               // Total game time in milliseconds
  startTime: string;              // ISO 8601 format
  endTime: string;                // ISO 8601 format
  
  // Core game data
  gameData: GameData;
  
  // AI-specific data (present even for manual play)
  aiData: AIData;
  
  // Combat metrics
  combatStats: CombatStats;
  
  // Economy metrics
  economyStats: EconomyStats;
  
  // Efficiency metrics
  efficiencyStats: EfficiencyStats;
  
  // Timeline snapshots
  timelineStats: TimelineStats;
  
  // Balance analysis (NEW - optional for backward compatibility)
  balanceAnalysis?: BalanceAnalysis;
  
  // Statistical analysis (NEW - optional)
  statisticalAnalysis?: StatisticalAnalysis;
  
  // Dashboard visualization data (NEW - optional)
  dashboardData?: DashboardData;
}
```

---

## GameData Interface

```typescript
interface GameData {
  highestWave: number;           // Maximum wave reached (1-based)
  finalMoney: number;            // Money remaining at game end
  finalLives: number;            // Lives remaining at game end
  startLives: number;            // Starting lives (typically 20)
  survivalRate: number;          // Percentage: (finalLives / startLives) * 100
  livesLost: number;             // Total lives lost: startLives - finalLives
}
```

**Example:**
```json
{
  "highestWave": 18,
  "finalMoney": 850,
  "finalLives": 19,
  "startLives": 20,
  "survivalRate": 95.0,
  "livesLost": 1
}
```

---

## AIData Interface

```typescript
interface AIData {
  towersBuilt: number;                          // Total towers placed
  towersUpgraded: number;                       // Total upgrade actions
  moneySpent: number;                           // Total money spent
  moneyEarned: number;                          // Total money earned
  peakMoney: number;                            // Maximum money held
  lowestLives: number;                          // Minimum lives during game
  averageBuildRate: number;                     // Towers per minute
  towerComposition: Record<string, number>;     // Count by tower type
  upgradeDistribution: Record<string, number[]>; // Upgrade levels by type
  waveStats: WaveStats;                         // Per-wave statistics
  performanceRating: string;                    // Star rating (‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê)
  defenseRating: string;                        // Shield rating (üõ°Ô∏è)
}
```

**Example:**
```json
{
  "towersBuilt": 15,
  "towersUpgraded": 12,
  "moneySpent": 3200,
  "moneyEarned": 4800,
  "peakMoney": 1500,
  "lowestLives": 18,
  "averageBuildRate": 2.14,
  "towerComposition": {
    "MACHINE_GUN": 6,
    "SNIPER": 4,
    "SHOTGUN": 3,
    "TESLA": 1,
    "FLAME": 1
  },
  "upgradeDistribution": {
    "MACHINE_GUN": [2, 2, 2, 3, 3, 3],
    "SNIPER": [2, 2, 3, 3]
  },
  "waveStats": { /* ... */ },
  "performanceRating": "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê EXCELLENT",
  "defenseRating": "üõ°Ô∏è PERFECT DEFENSE"
}
```

---

## WaveStats Interface

```typescript
interface WaveStats {
  completionTimes: number[];        // Time to complete each wave (ms)
  averageCompletionTime: number;    // Mean completion time (seconds)
  livesLostPerWave: number[];       // Lives lost in each wave
  averageLivesLostPerWave: number;  // Mean lives lost per wave
  towersBuiltPerWave: number[];     // Towers built during each wave
  decisionsPerWave: number[];       // AI decisions made per wave
}
```

---

## CombatStats Interface

```typescript
interface CombatStats {
  totalDamageDealt: number;                    // Total damage across all towers
  totalZombiesKilled: number;                  // Total zombie kills
  averageDPS: number;                          // Mean DPS throughout game
  peakDPS: number;                             // Maximum DPS achieved
  damageByTowerType: Record<string, number>;   // Damage per tower type
  killsByTowerType: Record<string, number>;    // Kills per tower type
  damagePerWave: number[];                     // Damage dealt each wave
  killsPerWave: number[];                      // Kills each wave
  overkillDamage: number;                      // Wasted damage on dead zombies
  accuracyRate: number;                        // Percentage of shots hit
  shotsHit: number;                            // Total successful hits
  shotsMissed: number;                         // Total missed shots
}
```

**Example:**
```json
{
  "totalDamageDealt": 68500.75,
  "totalZombiesKilled": 685,
  "averageDPS": 163.1,
  "peakDPS": 425.5,
  "damageByTowerType": {
    "MACHINE_GUN": 27400.3,
    "SNIPER": 22800.2
  },
  "killsByTowerType": {
    "MACHINE_GUN": 274,
    "SNIPER": 228
  },
  "damagePerWave": [1800, 2200, 2600, ...],
  "killsPerWave": [18, 22, 26, ...],
  "overkillDamage": 3425.04,
  "accuracyRate": 85.2,
  "shotsHit": 2556,
  "shotsMissed": 444
}
```

---

## EconomyStats Interface

```typescript
interface EconomyStats {
  moneyTimeline: MoneySnapshot[];      // Money snapshots every 5 seconds
  moneyPerWave: number[];              // Money earned each wave
  moneySpentPerWave: number[];         // Money spent each wave
  netIncomePerWave: number[];          // Net profit/loss per wave
  averageMoneyPerSecond: number;       // Mean income rate
  peakMoneyPerSecond: number;          // Maximum income rate
  totalIncome: number;                 // Total money earned
  totalExpenses: number;               // Total money spent
  netProfit: number;                   // Total income - expenses
  economyEfficiency: number;           // (income / expenses) * 100
  bankruptcyEvents: number;            // Times money reached 0
  cashFlowTrend: string;               // "GROWING" | "STABLE" | "DECLINING"
}

interface MoneySnapshot {
  time: number;                        // Milliseconds since game start
  money: number;                       // Money at this time
  wave: number;                        // Current wave number
}
```

**Example:**
```json
{
  "moneyTimeline": [
    {"time": 0, "money": 500, "wave": 1},
    {"time": 5000, "money": 700, "wave": 2}
  ],
  "moneyPerWave": [200, 250, 280, ...],
  "moneySpentPerWave": [150, 200, 150, ...],
  "netIncomePerWave": [50, 50, 130, ...],
  "averageMoneyPerSecond": 7.6,
  "peakMoneyPerSecond": 10.2,
  "totalIncome": 4800,
  "totalExpenses": 3200,
  "netProfit": 1600,
  "economyEfficiency": 150.0,
  "bankruptcyEvents": 0,
  "cashFlowTrend": "GROWING"
}
```

---

## EfficiencyStats Interface

```typescript
interface EfficiencyStats {
  damagePerDollar: number;           // Total damage / total spent
  killsPerDollar: number;            // Total kills / total spent
  damagePerTower: number;            // Average damage per tower
  killsPerTower: number;             // Average kills per tower
  upgradeEfficiency: number;         // Damage from upgraded towers / upgrade cost
  resourceUtilization: number;       // Percentage of money used effectively
  towerDensity: number;              // Total towers built
  averageUpgradeLevel: number;       // Mean upgrade level across all towers
  costEfficiencyRating: string;      // "EXCELLENT" | "GOOD" | "FAIR" | "POOR"
}
```

**Ratings:**
- EXCELLENT: damagePerDollar > 100
- GOOD: damagePerDollar 50-100
- FAIR: damagePerDollar 25-50
- POOR: damagePerDollar < 25

---

## TimelineStats Interface

```typescript
interface TimelineStats {
  snapshots: GameSnapshot[];         // Game state every 10 seconds
  snapshotInterval: number;          // Interval in milliseconds (10000)
}

interface GameSnapshot {
  time: number;                      // Milliseconds since game start
  wave: number;                      // Current wave
  money: number;                     // Current money
  lives: number;                     // Current lives
  towersActive: number;              // Number of towers placed
  zombiesAlive: number;              // Zombies currently alive
  currentDPS: number;                // DPS at this moment
}
```

---

## BalanceAnalysis Interface (NEW)

```typescript
interface BalanceAnalysis {
  issues: BalanceIssue[];                           // Detected balance problems
  waveDefenseAnalysis: WaveDefenseAnalysis[];       // Lanchester's Law analysis
  towerEfficiencies: Record<string, TowerEfficiency>; // Tower performance metrics
  threatScores: Record<string, ThreatScore>;        // Zombie difficulty ratings
  optimalTowerMix: Record<string, number>;          // Calculated optimal composition
  actualTowerMix: Record<string, number>;           // Actual towers built
  mixDeviation: number;                             // Percentage difference
  overallBalanceRating: string;                     // Overall assessment
}
```

### BalanceIssue Interface

```typescript
interface BalanceIssue {
  type: string;                      // Issue type identifier
  severity: string;                  // "LOW" | "MEDIUM" | "HIGH" | "CRITICAL"
  message: string;                   // Human-readable description
  value: number;                     // Actual metric value
  threshold: number;                 // Expected threshold
  recommendation: string;            // Suggested fix
}
```

**Issue Types:**
- `WEAK_DEFENSE` - Survival rate too low
- `INEFFICIENT_TOWERS` - Damage per dollar too low
- `EXCESSIVE_OVERKILL` - Too much wasted damage
- `NEGATIVE_ECONOMY` - Spending exceeds income

**Example:**
```json
{
  "type": "WEAK_DEFENSE",
  "severity": "CRITICAL",
  "message": "Survival rate is 0.0%, below threshold of 50%",
  "value": 0.0,
  "threshold": 50.0,
  "recommendation": "Build more towers and upgrade existing ones"
}
```

---

### WaveDefenseAnalysis Interface

```typescript
interface WaveDefenseAnalysis {
  wave: number;                      // Wave number analyzed
  canDefend: boolean;                // Can current DPS handle wave?
  totalZombieHP: number;             // Total HP of all zombies
  totalTowerDPS: number;             // Combined DPS of all towers
  timeToReachEnd: number;            // Seconds for zombies to reach end
  damageDealt: number;               // Total damage towers can deal
  damageRequired: number;            // Damage needed to kill all zombies
  safetyMargin: number;              // Percentage of excess capacity
  recommendation: string;            // Action to take
}
```

**Formula:**
```
damageDealt = totalTowerDPS √ó timeToReachEnd
safetyMargin = ((damageDealt - damageRequired) / damageRequired) √ó 100
canDefend = damageDealt >= damageRequired
```

**Example:**
```json
{
  "wave": 10,
  "canDefend": true,
  "totalZombieHP": 8500,
  "totalTowerDPS": 285.3,
  "timeToReachEnd": 35.0,
  "damageDealt": 9985.5,
  "damageRequired": 8500,
  "safetyMargin": 17.5,
  "recommendation": "Defense is adequate with 17.5% safety margin"
}
```

---

### TowerEfficiency Interface

```typescript
interface TowerEfficiency {
  type: string;                      // Tower type identifier
  cost: number;                      // Total cost (build + upgrades)
  dps: number;                       // Nominal DPS
  range: number;                     // Tower range
  accuracy: number;                  // Hit rate (0.0-1.0)
  efficiencyScore: number;           // (DPS √ó Range √ó Accuracy) / Cost
  effectiveDPS: number;              // DPS after accounting for overkill
  breakEvenTime: number;             // Seconds to recoup investment
}
```

**Formulas:**
```
efficiencyScore = (dps √ó range √ó accuracy) / cost
effectiveDPS = dps √ó (1 - overkillPercent)
breakEvenTime = cost / (avgZombieReward / killTime)
```

**Example:**
```json
{
  "type": "SNIPER",
  "cost": 200,
  "dps": 80,
  "range": 250,
  "accuracy": 0.95,
  "efficiencyScore": 95.0,
  "effectiveDPS": 78.4,
  "breakEvenTime": 22.5
}
```

---

### ThreatScore Interface

```typescript
interface ThreatScore {
  zombieType: string;                // Zombie type identifier
  health: number;                    // Base HP
  speed: number;                     // Movement speed
  count: number;                     // Number spawned
  reward: number;                    // Money per kill
  threatScore: number;               // Calculated threat rating
  threatPerDollar: number;           // Threat relative to reward
  isBalanced: boolean;               // Is threat score in 0.8-1.2 range?
}
```

**Formula:**
```
threatScore = (health √ó speed √ó count) / (reward √ó 10)
isBalanced = threatScore >= 0.8 && threatScore <= 1.2
```

**Example:**
```json
{
  "zombieType": "BASIC",
  "health": 100,
  "speed": 50,
  "count": 350,
  "reward": 10,
  "threatScore": 1.75,
  "threatPerDollar": 0.175,
  "isBalanced": false
}
```

---

## StatisticalAnalysis Interface (NEW)

```typescript
interface StatisticalAnalysis {
  damageOutliers: OutlierAnalysis;       // Unusual damage values
  dpsOutliers: OutlierAnalysis;          // Unusual DPS values
  economyOutliers: OutlierAnalysis;      // Unusual economy values
  difficultyTrend: TrendAnalysis;        // Wave difficulty progression
  wavePredictions: WavePrediction[];     // Future wave forecasts
  summary: StatisticalSummary;           // Aggregate statistics
}
```

### OutlierAnalysis Interface

```typescript
interface OutlierAnalysis {
  mean: number;                          // Average value
  standardDeviation: number;             // Spread of values
  outliers: Outlier[];                   // Values >2 std devs from mean
  hasOutliers: boolean;                  // Quick check flag
}

interface Outlier {
  value: number;                         // Outlier value
  index: number;                         // Wave/index where it occurred
  deviation: number;                     // Standard deviations from mean
}
```

**Example:**
```json
{
  "mean": 163.1,
  "standardDeviation": 85.4,
  "outliers": [
    {"value": 425.5, "index": 17, "deviation": 3.07}
  ],
  "hasOutliers": true
}
```

---

### TrendAnalysis Interface

```typescript
interface TrendAnalysis {
  trend: string;                         // "GETTING_HARDER" | "GETTING_EASIER" | "STABLE"
  slope: number;                         // Rate of change
  intercept: number;                     // Y-intercept of trend line
  rSquared: number;                      // Goodness of fit (0-1)
  confidence: string;                    // "HIGH" | "MEDIUM" | "LOW"
}
```

**Confidence Levels:**
- HIGH: rSquared > 0.85
- MEDIUM: rSquared 0.65-0.85
- LOW: rSquared < 0.65

**Example:**
```json
{
  "trend": "GETTING_HARDER",
  "slope": 0.18,
  "intercept": 1500,
  "rSquared": 0.96,
  "confidence": "HIGH"
}
```

---

### WavePrediction Interface

```typescript
interface WavePrediction {
  wave: number;                          // Future wave number
  predictedDifficulty: number;           // Expected zombie HP
  recommendedDPS: number;                // DPS needed to defend
  confidenceInterval: {                  // Prediction range
    lower: number;
    upper: number;
  };
}
```

**Example:**
```json
{
  "wave": 19,
  "predictedDifficulty": 16200,
  "recommendedDPS": 463.0,
  "confidenceInterval": {"lower": 15800, "upper": 16600}
}
```

---

### StatisticalSummary Interface

```typescript
interface StatisticalSummary {
  avgDamagePerWave: number;              // Mean damage per wave
  avgDPSPerWave: number;                 // Mean DPS per wave
  avgEconomyEfficiency: number;          // Mean economy efficiency
  performanceConsistency: number;        // Percentage (0-100)
}
```

---

## DashboardData Interface (NEW)

```typescript
interface DashboardData {
  labels: string[];                      // X-axis labels (wave numbers)
  datasets: {
    playerDPS: number[];                 // Player's DPS over time
    requiredDPS: number[];               // Required DPS over time
    damagePerDollar: number[];           // Efficiency over time
    economyEfficiency: number[];         // Economy health over time
    survivalRate: number[];              // Lives remaining over time
    threatLevel: number[];               // Zombie threat over time
  };
}
```

**Purpose:**
- Formatted for Chart.js
- Ready to visualize without transformation
- All arrays same length as labels

**Example:**
```json
{
  "labels": ["Wave 1", "Wave 3", "Wave 5", "Wave 7"],
  "datasets": {
    "playerDPS": [95.2, 158.4, 225.6, 285.3],
    "requiredDPS": [51.4, 97.1, 142.9, 165.7],
    "damagePerDollar": [12.0, 17.3, 19.8, 20.5],
    "economyEfficiency": [100, 125, 142, 148],
    "survivalRate": [100, 100, 100, 100],
    "threatLevel": [1.0, 1.4, 1.8, 2.0]
  }
}
```

---

## Field Validation Rules

### Required Fields
All reports MUST include:
- `timestamp`
- `sessionId`
- `isAIRun`
- `duration`
- `gameData`
- `aiData`
- `combatStats`
- `economyStats`
- `efficiencyStats`
- `timelineStats`

### Optional Fields
These fields are optional for backward compatibility:
- `balanceAnalysis`
- `statisticalAnalysis`
- `dashboardData`

### Data Type Constraints

**Numbers:**
- All percentages: 0-100
- All money values: >= 0
- All time values: >= 0
- DPS values: >= 0
- Wave numbers: >= 1

**Strings:**
- Timestamps: ISO 8601 format
- Session IDs: Alphanumeric with underscores
- Ratings: Predefined emoji + text format

**Arrays:**
- All per-wave arrays must have same length
- Timeline snapshots sorted by time ascending
- Money timeline sorted by time ascending

---

## JSON Serialization Notes

### Map to Object Conversion

TypeScript Maps must be converted to plain objects:

```typescript
// Convert Map to object
const plainObject: Record<string, number> = {};
mapData.forEach((value, key) => {
  plainObject[key] = value;
});
```

**Affected Fields:**
- `towerComposition`
- `upgradeDistribution`
- `damageByTowerType`
- `killsByTowerType`
- `towerEfficiencies`
- `threatScores`
- `optimalTowerMix`
- `actualTowerMix`

### Floating Point Precision

All floating point numbers rounded to 2 decimal places for readability:

```typescript
const rounded = Math.round(value * 100) / 100;
```

### Null vs Undefined

- Use `undefined` for optional fields not present
- Never use `null` in reports
- Empty arrays preferred over undefined for collections

---

## File Naming Convention

Reports saved with this format:
```
YYYY-MM-DD_HH-MM-SS_TYPE_waveX.json
```

**Examples:**
- `2025-10-15_15-45-30_AI_wave18.json`
- `2025-10-15_16-20-15_MANUAL_wave8.json`

**Special Files:**
- `EXAMPLE_REPORT.json` - Template report
- `EXAMPLE_BALANCED_GAME.json` - Well-balanced game example
- `EXAMPLE_WEAK_DEFENSE.json` - Problematic game example

---

## Backward Compatibility

### Version 1.0 (Original)
- Includes all fields except balance analysis
- Compatible with existing report viewers
- No breaking changes

### Version 2.0 (With Balance Analysis)
- Adds `balanceAnalysis` field (optional)
- Adds `statisticalAnalysis` field (optional)
- Adds `dashboardData` field (optional)
- Fully backward compatible

**Compatibility Check:**
```typescript
function hasBalanceAnalysis(report: GameLogEntry): boolean {
  return report.balanceAnalysis !== undefined;
}
```

---

## Usage Examples

### Reading a Report

```typescript
import reportData from './player_reports/EXAMPLE_BALANCED_GAME.json';

// Access basic data
console.log(`Wave: ${reportData.gameData.highestWave}`);
console.log(`Survival: ${reportData.gameData.survivalRate}%`);

// Check for balance analysis
if (reportData.balanceAnalysis) {
  console.log(`Balance Rating: ${reportData.balanceAnalysis.overallBalanceRating}`);
  console.log(`Issues: ${reportData.balanceAnalysis.issues.length}`);
}
```

### Filtering Reports

```typescript
// Find all critical balance issues
const criticalReports = reports.filter(report => 
  report.balanceAnalysis?.issues.some(issue => 
    issue.severity === 'CRITICAL'
  )
);

// Find high-performing games
const excellentGames = reports.filter(report =>
  report.gameData.survivalRate >= 90 &&
  report.gameData.highestWave >= 15
);
```

### Aggregating Data

```typescript
// Calculate average survival rate across all reports
const avgSurvival = reports.reduce((sum, r) => 
  sum + r.gameData.survivalRate, 0
) / reports.length;

// Find most common balance issues
const issueFrequency = new Map<string, number>();
reports.forEach(report => {
  report.balanceAnalysis?.issues.forEach(issue => {
    issueFrequency.set(
      issue.type,
      (issueFrequency.get(issue.type) || 0) + 1
    );
  });
});
```

---

## Related Documentation

- `REPORT_INTERPRETATION_GUIDE.md` - How to analyze reports
- `BALANCE_ANALYSIS_GUIDE.md` - Balance analysis overview
- `BALANCE_CONFIG_REFERENCE.md` - Configuration and formulas
- `BALANCE_ANALYSIS_EXAMPLES.md` - Example scenarios

---

_Last Updated: 2025-10-15_
_Version: 2.0_
